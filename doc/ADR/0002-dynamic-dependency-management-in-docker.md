# 0002. Dockerコンテナ内での動的な依存関係管理

- **ステータス**: 採用 (Accepted)
- **決定日**: 2026-02-11
- **検討者**: User
- **タグ**: infrastructure, docker, uv, workflow

## コンテキスト (Context)

これまでの開発フローでは、`pyproject.toml` に新しい依存関係を追加するたびに `docker compose up --build` を実行し、コンテナイメージを再構築していた。これは以下の問題を引き起こしていた。

1.  **時間的コスト**: コンテナの再ビルドには時間がかかり、開発サイクルを遅くする。
2.  **検証のハードル**: ライブラリを試しに追加・削除するだけで再ビルドが必要になるのは非効率。

## 決定 (Decision)

開発中の依存関係管理については、以下のフローを採用する。

1.  **コンテナ内での変更**: 新しいパッケージが必要になった場合、ホスト側で `pyproject.toml` を編集してリビルドするのではなく、**実行中のコンテナ内で `uv add <package>` コマンドを実行する**。
2.  **永続化**: コンテナ内で追加された依存関係は `pyproject.toml` および `uv.lock` に反映される。これらのファイルはホストとマウントされている（または同期される）ため、ホスト側のコードリポジトリにも変更が反映される。
3.  **定期的なリビルド**: ただし、CI環境や他の開発者が環境を再現するためには `Dockerfile` に基づくビルドが必要であるため、`pyproject.toml` が更新されたタイミングで適宜リビルドを行うことは推奨されるが、毎回の変更時には不要とする。

## 詳細 (Implications)

-   `docker-compose.yml` において、`pyproject.toml` と `uv.lock` をホスト側と同期（マウント）する必要がある。
    -   現状の構成では `src` と `sandbox` のみがマウントされているため、**ルートディレクトリ全体または `pyproject.toml` をマウントする** 設定変更が必要となる。
-   `uv add` コマンドは、デフォルトで仮想環境を操作しようとするが、Dockerコンテナ内ではシステム環境 (`--system`) を使っている場合がある。`uv` の挙動に合わせてフラグが必要になるかもしれない（またはコンテナ内でも仮想環境を使うか）。

## 備考 (Notes)

-   この変更により、ライブラリの試行錯誤が高速化される。
-   `docker-compose.yml` の `volumes` 設定を見直す必要がある。
