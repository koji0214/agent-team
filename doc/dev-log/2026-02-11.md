# 開発日誌: 2026-02-11 (水)

## 今日の概要
プロジェクトの初期セットアップ、基本アーキテクチャの決定、および Docker / uv 環境の構築を中心に行った。また、API クォータ問題が発生したが、プログラムの修正と検証を経て、現在は正常に動作している。

## 実施事項
- **プロジェクト初期化**: `pyproject.toml`, `compose.yaml` (旧 `docker-compose.yml`) の作成。
- **アーキテクチャ設計**: エージェントチーム（Manager, Architect, Coder...）の役割分担を定義。
- **ベースクラスの実装**: `Agent` (基底クラス) および `Manager` クラスの Python 実装。
- **エージェント間連携の実装**: Function Calling (Tools) を使用し、Manager が Architect にタスクを委任 (`delegate_task`) し、結果をタスク分解 (`decompose_task`) する自律的なフローを実現。
- **自動関数呼び出し (Automatic Function Calling)**: Gemini 1.5 の SDK 機能を活用し、再帰的な呼び出しを含むエージェント間の対話を自動化。
- **テスト環境の構築**: `pytest` を導入し、モックを使用した単体テストを実装。
- **CLI 実装**: `typer` と `rich` を使った `main.py` のチャットインターフェースを実装。
- **`Coder` エージェントの実装**: Python コード生成と修正機能。
- **サンドボックススキル (Sandbox Skill) の実装**: 生成されたコードの実行と結果の取得。
- **ドキュメンテーション**:
    - ADR (0001〜0003) の作成。
    - テンプレート (ADR, ポストモーテム) の整備。
    - ディレクトリ構成の整理（`doc/` 配下へ）。

## 発生した課題と解決策
- **API クォータ超過 (429 Error) と無限ループ**:
    - **原因**: 複数のエージェントが連携すると短時間に API リクエストが集中する。また、SDK の自動関数呼び出しを使用すると、リトライ時にチャット履歴が重複し、エージェントが同じツールを無限に呼び出す「ゾンビ・ループ」が発生していた。
    - **解決**: 
        1. **「手動関数呼び出しループ」の導入**: `enable_automatic_function_calling=False` に設定し、エージェント基底クラスで明示的にループと待機（インターバル）を制御。
        2. **リトライプロトコルの洗練**: 指数バックオフを用いたリトライを実装し、失敗したターンの履歴を重複させないように修正。
        3. **モデルの安定運用**: ツール実行を確実に行うため、現在は `gemini-1.5-flash` 系などの FC 安定モデルの使用を前提に調整中。
- **Gemma 3 1B の試行**: クォータ上限が高いため試行したが、モデルが軽量すぎて Function Calling を正しく解釈・実行できないことが判明。
- **Gemini 2.0 / 2.5 の選択**: `gemini-2.5-flash-lite` はクォータに達しやすく、`gemini-2.0-flash` は現在利用上限（limit: 0 等）の制限により試行が困難な状況。

## 明日の予定 / 次のステップ
- `Architect` エージェントの実装。
- Manager から Architect へのタスク委譲ロジックの実装。
- エージェント間通信のプロトコル洗練。

## 技術メモ: Gemini API クォータ制限 (2026年2月時点)
2026年2月現在、Gemini API（Google AI Studio）の無料枠におけるモデル別上限と、429エラーが発生する具体的な条件をまとめました。モデルの世代交代が進み、2025年末から2026年初頭にかけて制限が従来より厳格化されています。

### 📊 モデル別・無料枠の上限一覧
無料枠では、以下の3つの指標のどれか1つでも超えると「429 Resource Exhausted」エラーが発生します。

| モデル名 | 1分間の回数 (RPM) | 1日の合計回数 (RPD) | 1分間のトークン量 (TPM) |
| :--- | :--- | :--- | :--- |
| Gemini 2.5 Pro | 5 回 | 100 回 | 250,000 |
| Gemini 2.5 Flash | 10 回 | 250 回 | 250,000 |
| Gemini 2.5 Flash-Lite | 15 回 | 1,000 回 | 250,000 |
| Gemini 3 Pro (Preview) | 10 回 | 100 回 | 250,000 |

> [!NOTE]
> **Gemini 2.0 シリーズについて**
> 2.0シリーズ（Flash等）は現在、2.5シリーズと共通の「クラス枠」としてカウントされます。例えば、2.0 Flashと2.5 Flashを混ぜて使っても、合計のFlash上限に達すると制限がかかります。

### 🚨 429エラーが発生する「3つの条件」
「429 You exceeded your current quota」が出る理由は、大きく分けて以下の3パターンです。

1. **秒速でのリクエスト（RPM制限）**
   - **条件**: 1分間に規定の回数（例：Flashなら10回）を超えてリクエストを送った場合。
   - **特徴**: 「あと数秒〜数十秒待てば」 解除されます。
   - **対策**: プログラムに `time.sleep(10)` を入れるなどして、リクエスト間隔を空けます。

2. **1日の使いすぎ（RPD制限）**
   - **条件**: その日の合計リクエスト数が上限（例：Proなら100回）に達した場合。
   - **特徴**: 「翌日まで」 解除されません。
   - **リセット時間**: 通常、**日本時間の午後5時（太平洋標準時の午前0時）**にリセットされます。

3. **一度に送るデータが多すぎる（TPM制限）**
   - **条件**: 1リクエストの文字数（トークン）が多すぎる、または短い時間に大量の長文を連続で送った場合。
   - **特徴**: 回数（RPM）は守っていても、データの「重さ」で制限がかかります。
   - **対策**: 長いPDFや大量のソースコードを一度に読み込ませるのを控えるか、分割して送信します。

---
*作成者: Antigravity*
