# ポストモーテム: 無限ループによるAPIクォータの過剰消費と誤診断

- **日付**: 2026-02-11
- **ステータス**: 解決済み
- **作成者**: Antigravity (AIエージェント)

## 概要

`main.py` の実行中に、入力ループの制限不備により Gemini API に対して短時間で大量のリクエストが送信され、`429 Too Many Requests` および `Quota Exceeded` エラーが発生した。この際、AIエージェント側の誤診断により、根本原因である「無限ループ」の特定が遅れ、環境やモデルの制限が原因であると誤認して対応を継続した。

## タイムライン

- **17:04**: `main.py` の初期実装を完了し、実行を開始。
- **17:33**: ユーザーから「リクエストが通らない」との報告を受け、AIが「モデルの利用権限不足（クォータ 0）」と誤った原因分析を行う。
- **17:38**: モデル名の変更などを試みるが、改善せず。
- **17:41**: ユーザーが Google AI Studio コンソールで「TooManyRequests」の異常な継続を確認し、AIに報告。
- **17:45**: AIが実装コード（`main.py`）を再点検し、入力ループに構造的欠陥があることを特定。
- **17:48**: `main.py` に例外ハンドリングとエラー時の待機時間を追加し、修正版を適用。
- **17:50**: ユーザーにより動作正常化を確認。

## 根本原因 (Root Causes)

1.  **入力ループの実装不備 (無限ループ)**:
    `main.py` の `while True` ループにおいて、標準入力が切断される環境や特定のエラー時に、プログラムがユーザー入力を待たずに `agent.send_message("")` を高速で呼び出し続ける状態に陥った。これが Cloud Console で確認された「リクエストを送り続けている」状態の正体であった。
2.  **AIによる原因分析の誤り (誤診断)**:
    APIが返した `limit: 0` というメッセージを、初期状態の権限不足であると誤認した。実際には、無限ループによる過剰リクエストの結果として無料枠のクォータを瞬時に使い果たしたために発生した動的な制限であった。
3.  **エラー時のフィードバック制御の欠如**:
    API呼び出し失敗時に速やかにループの先頭に戻る設計であったため、一度エラーが発生するとそのまま指数関数的にリクエストが加速する構造になっていた。

## 影響 (Impact)

- **API 利用制限**: Google AI Studio でのクォータを短時間で消費し、一時的にサービスが利用不可となった。
- **ユーザー体験**: アプリが応答不能（またはエラーの連打）となり、開発が中断した。

## 是正措置 (Corrective Actions)

1.  **CLIループの堅牢化**: `main.py` において、`EOFError` および `Aborted` を明示的にキャッチし、入力異常時に安全に終了するように修正。
2.  **レートリミット対策の実装**: API エラー発生時にループ内で **強制的に待機 (`time.sleep`)** を差し込み、不慮の連打が発生しないガードレールを構築。
3.  **診断精度の向上**: API エラーが発生した際、環境（モデル）の問題だけでなく、自身のプログラムの挙動（ループやリトライ）に疑いの目を向けるようにプロンプトとロジックを再確認した。
4.  **モデル選択の動的化**: `Agent` クラスにおいてモデル名を環境変数から取得可能にし、デフォルトをより安定した `gemini-flash-lite-latest` に調整した。

## 再発防止策 (Prevention)

1.  **「失敗時は待機」の原則の徹底**: 外部 API やリソースにアクセスするループ処理では、いかなる場合も失敗時の待機時間を設けることを開発標準とする。
2.  **診断ツールの活用と早期原因分析**: 環境差異（モデルの可用性等）を早期に発見するための診断スクリプトを用意するとともに、不具合発生時は外部要因（API制限等）だけでなく自身のコード（無限ループやバグ）をまず疑う習慣を徹底する。
3.  **ADR および開発基準への反映**: 今後の外部通信を伴う実装において、レートリミットとリトライ戦略を考慮することをアーキテクチャの基本方針 (ADR) に含め、ルール化する。
4.  **ポストモーテムの活用**: 本事例を教訓として記録し、今後のエージェント開発において同様の「ループ暴走」を防ぐためのチェックリストとして活用する。

